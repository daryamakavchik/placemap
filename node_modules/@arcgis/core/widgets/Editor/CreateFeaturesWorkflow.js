/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{makeHandle as a,handlesGroup as i}from"../../core/handleUtils.js";import{unwrap as r,removeMaybe as o,isSome as n,isNone as s,destroyMaybe as l}from"../../core/maybe.js";import{watch as c,syncAndInitial as d}from"../../core/reactiveUtils.js";import{generateUUID as u}from"../../core/uuid.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Error.js";import"../../core/has.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import f from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as p}from"./CreateFeaturesWorkflowData.js";import m from"./Workflow.js";import{startCreatingNewFeature as w,findLayerInfo as g,updateGraphicSymbolWhenRequired as v,isTerminalUpdateEventType as _,getVisualVariableAttributes as y,startUpdatingFeature as M,createWorkflowSteps as b,avoidFeatureTemplateSelectionWithOnlyOneItem as F,visualVariableInteractiveUpdate as A}from"./workflowUtils.js";var V;let I=V=class extends m{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1}get numPendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics.length}get pendingFeatures(){return this.data.viewModel.sketchViewModel.layer.graphics}async updatePendingFeature(e,a){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this._lastActiveGraphics,e),this._startUpdating(e,a)}static create(e,t,a,i,o){const n=new V({data:new p({creationInfo:r(t),viewModel:e}),onCommit:async e=>{const t=e.viewModel.sketchViewModel.layer.graphics.toArray(),a=e.creationInfo.layer,r=a.capabilities.editing.supportsGlobalId&&"globalIdField"in a,s=n._attachmentFileInfos;if(0===s.size)return void await i(a,{addFeatures:t});if(r){const e=n._getAttachmentEditsWithGlobalIds(t,a,s),r="addAttachments"in e?{globalIdUsed:!0}:void 0;return void await i(a,e,r)}const{addFeatureResults:l}=await i(a,{addFeatures:t}),c=n._getAddAttachmentsData(t,l,a,s);await o(a,c)}});return n._set("steps",this._createWorkflowSteps(n,a)),n}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",a((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,a((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){o(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){return this.createFeatureState="create-new",w(this.data.viewModel.sketchViewModel,this.data.creationInfo,e)}async _startUpdating(e,t){const{featureFormViewModel:a,layerInfos:r,sketchViewModel:s,view:l}=this.data.viewModel,c=this.data.creationInfo.layer,d=g(r,c)?.formTemplate,u=l.spatialReference;return a.set({arcadeEditType:"INSERT",feature:e,formTemplate:d,spatialReference:u,view:l}),o(this._featureFormHandle),this._featureFormHandle=i([a.on("value-change",(async()=>{e.attributes=a.getValues(),await v(e,t)})),s.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&n(e.toolEventInfo)&&_(e.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()}))]),this._removeHighlight(e),this.createFeatureState="update-pending",this._visualVariableAttributes=y(e),M(s,e,c,this._visualVariableAttributes,t)}static _createWorkflowSteps(e,a="awaiting-feature-creation-info"){const{data:i,handles:r}=e;let u=null,h=!0;const p=new Map,m=b(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],a,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){i.creationInfo=null,r.add(i.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>{i.creationInfo={layer:e.layer,template:e.template},i.viewModel.activeWorkflow.next()})),this.id)},async tearDown(){r.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(r.has(this.id))return;const a=i.viewModel.view,m=i.viewModel.sketchViewModel;h=m.updateOnGraphicClick,m.updateOnGraphicClick=!1,e._lastActiveGraphics=[],e._featureFormHandle=o(e._featureFormHandle),e._visualVariableAttributes={rotation:null,size:null};const w="2d"===a.type?e._fadeExistingFeatures(i.creationInfo.layer):null,g=m.on("create",(async t=>{if("cancel"===t.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(p);const t=e._lastActiveGraphics.pop();return e._startUpdating(t,p)}if("complete"===t.state)return e._startUpdating(t.graphic,p)})),v=m.on("update",(async t=>{const r=t.graphics[0];if("complete"===t.state)return r!==u&&(e._lastActiveGraphics.push(r),e._highlight(r)),u=null,"add"!==i.viewModel.attachmentsViewModel.mode&&"edit"!==i.viewModel.attachmentsViewModel.mode||i.viewModel.activeWorkflow.previous(),t.aborted&&e._preventDefaultActionOnCancel?void(e._preventDefaultActionOnCancel=!1):e._startCreating(p);if("start"===t.state){e._removeHighlight(r);const t=i.viewModel.attachmentsViewModel;"add"!==t.mode&&"edit"!==t.mode||i.viewModel.activeWorkflow.previous(),t.fileInfos.removeAll(),t.graphic=r,t.mode="view";(e._attachmentFileInfos.get(r)||[]).forEach((({file:e,form:a})=>t.addFile(e,a)))}await A(a,r,t,e._visualVariableAttributes,p);const o=r.attributes;if(n(e._visualVariableAttributes.rotation)){const{field:t}=e._visualVariableAttributes.rotation;i.viewModel.featureFormViewModel.setValue(t,o[t])}if(n(e._visualVariableAttributes.size)){const{field:t}=e._visualVariableAttributes.size;i.viewModel.featureFormViewModel.setValue(t,o[t])}})),_=m.on("delete",(async a=>{const i=a.graphics[0];t(e._lastActiveGraphics,i),u=i}));let y=null;const M=c((()=>{const e=m.snappingOptions.featureSources.find((e=>e.layer===i.creationInfo.layer));return{hasFeatureLayerSource:!!e,enabled:e?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{const a=m.snappingOptions.featureSources;e?(s(y)&&(y=new f({layer:m.layer,enabled:t}),a.add(y)),y.enabled=t):(n(y)&&a.remove(y),y=l(y))}),d),b=a.on("immediate-click",(async t=>{const{results:i}=await a.hitTest(t,{include:m.layer}),r=i.find((e=>"graphic"===e.type));if(r){const t=r.graphic;if("transform"===m.activeTool||"reshape"===m.activeTool){if(m.updateGraphics.getItemAt(0)===t)return;await e.updatePendingFeature(t,p)}}})),F=c((()=>i.viewModel.attachmentsViewModel.mode),(e=>{"add"===e&&i.viewModel.activeWorkflow.go("adding-attachment"),"edit"===e&&i.viewModel.activeWorkflow.go("editing-attachment")}));await e._startCreating(p);const V={remove:()=>{o(e._featureFormHandle),g.remove(),v.remove(),_.remove(),M.remove(),n(y)&&m.snappingOptions.featureSources.remove(y),y=l(y),m.cancel(),b.remove(),F.remove(),o(w)}};r.add(V,this.id)},async tearDown(t){t.cancelled&&(i.viewModel.sketchViewModel.layer.removeAll(),r.remove(this.id),i.viewModel.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear(),i.viewModel.sketchViewModel.updateOnGraphicClick=h)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{graphic:t,fileInfos:a}=i.viewModel.attachmentsViewModel;e._attachmentFileInfos.set(t,a.toArray()),i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{graphic:t,fileInfos:a}=i.viewModel.attachmentsViewModel;e._attachmentFileInfos.set(t,a.toArray()),i.viewModel.attachmentsViewModel.mode="view"}})});return F(i,m)}_getAddAttachmentsData(e,t,a,i){const r=[];return t.forEach(((t,o)=>{if(!t.error){const n=e[o],s=i.get(n)||[];n.attributes[a.objectIdField]=t.objectId,s.forEach((({form:e})=>r.push({feature:n,attachment:e})))}})),r}_getAttachmentEditsWithGlobalIds(e,t,a){const i=[];return e.forEach(((r,o)=>{const n=a.get(r)||[];let l=r.attributes[t.globalIdField];s(l)&&(l=u(),e[o].attributes[t.globalIdField]=l),n.forEach((({file:e})=>i.push({feature:r,attachment:{globalId:u(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}};I=V=e([h("esri.widgets.Editor.CreateFeaturesWorkflow")],I);const k=I;export{k as default};
