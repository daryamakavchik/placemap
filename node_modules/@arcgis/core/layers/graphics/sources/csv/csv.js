/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_parseInfo as e}from"../../../../core/number.js";const t=/^\s*"([\S\s]*)"\s*$/,n=/""/g,i="\n",r=[","," ",";","|","\t"];function*o(e,t,n){let i=0;for(;i<=e.length;){const r=e.indexOf(t,i),o=e.substring(i,r>-1?r:void 0);i+=o.length+t.length,n&&!o.trim()||(yield o)}}function l(e){const t=e.includes("\r\n")?"\r\n":i;return o(e,t,!0)}function s(e,t){return o(e,t,!1)}function u(e,t,n){e=e.trim(),t=t?.trim();const i=[],o=Array.from(new Set([n?.delimiter,...r])).filter((e=>null!=e));for(const r of o){const n=a(e,r).length,o=a(t,r).length??n;n>1&&i.push({weight:Math.min(n,o),delimiter:r})}const l=i.sort((({weight:e},{weight:t})=>t-e)).map((({delimiter:e})=>e));for(const r of l){const t=f(a(e,r).filter(Boolean),n?.longitudeField,n?.latitudeField);if(t.longitudeFieldName&&t.latitudeFieldName)return{delimiter:r,locationInfo:t}}return{delimiter:l[0],locationInfo:null}}function*c(e,r,o,u=(()=>Object.create(null))){const c=l(e);c.next();let a="",f="",g=0,m=u(),p=0;e:for(const l of c){const e=s(l,o);for(const i of e)if(a+=f+i,f="",g+=d(i),g%2==0){if(g>0){const e=t.exec(a);if(!e){m=u(),p=0,a="",g=0;continue e}m[r[p]]=e[1].replace(n,'"'),p++}else m[r[p]]=a,p++;a="",g=0}else f=o;0===g?(yield m,m=u(),p=0):f=i}}function a(e,i){if(!e?.length)return[];const r=[];let o="",l="",u=0;const c=s(e,i);for(const s of c)if(o+=l+s,l="",u+=d(s),u%2==0){if(u>0){const e=t.exec(o);e&&r.push(e[1].replace(n,'"'))}else r.push(o);o="",u=0}else l=i;return r}function d(e){let t=0,n=0;for(n=e.indexOf('"',n);n>=0;)t++,n=e.indexOf('"',n+1);return t}function f(e,t,n){e=e.map((e=>e.trim())),t=t?.toLowerCase().trim(),n=n?.toLowerCase().trim();const i=e.map((e=>e.toLowerCase())),r=t?e[i.indexOf(t)]:void 0,o=n?e[i.indexOf(n)]:void 0;return{longitudeFieldName:r||e[i.indexOf(y.find((e=>i.includes(e))))],latitudeFieldName:o||e[i.indexOf(x.find((e=>i.includes(e))))]}}function g(e,t,n,i){const r=[],o=c(e,n,t),l=[];for(const s of o){if(10===l.length)break;l.push(s)}for(const s of n)if(s===i.longitudeFieldName||s===i.latitudeFieldName)r.push({name:s,type:"esriFieldTypeDouble",alias:s});else{let e,t;switch(m(l.map((e=>e[s])))){case"integer":e="esriFieldTypeInteger";break;case"double":e="esriFieldTypeDouble";break;case"date":e="esriFieldTypeDate",t=36;break;default:e="esriFieldTypeString",t=255}r.push({name:s,type:e,alias:s,length:t})}return r}function m(e){if(!e.length)return"string";const t=/[^+-.,0-9]/;return e.map((e=>{let n=!1;if(""!==e){if(t.test(e))n=!0;else{let t=b(e);if(!isNaN(t))return/[.,]/.test(e)||!Number.isInteger(t)||t>214783647||t<-214783648?"double":"integer";if(e.includes("E")){if(t=Number(e),!isNaN(t))return"double";if(e.includes(",")){if(e=e.replace(",","."),t=Number(e),!isNaN(t))return"double";n=!0}else n=!0}else n=!0}if(n){if(!/^[-]?\d*[.,]?\d*$/.test(e)){return p(new Date(e),e)?"date":"string"}return"string"}return"string"}})).reduce(((e,t)=>void 0===e?t:void 0===t?e:e===t?t:"string"===e||"string"===t?"string":"double"===e||"double"===t?"double":void 0))}function p(e,t){if(!e||"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime()))return!1;let n=!0;if(!N&&/\d+\W*$/.test(t)){const e=t.match(/[a-zA-Z]{2,}/);if(e){let t=!1,i=0;for(;!t&&i<=e.length;)t=!h.test(e[i]),i++;n=!t}}return n}const b=function(){const t=e(),n=new RegExp("^"+t.regexp+"$"),i=new RegExp("["+t.group+"\\s\\xa0]","g"),r=t.factor;return e=>{const o=n.exec(e);if(t.factor=r,!o)return NaN;let l=o[1];if(!o[1]){if(!o[2])return NaN;l=o[2],t.factor*=-1}return l=l.replace(i,"").replace(t.decimal,"."),+l*t.factor}}(),h=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i,N=Number.isNaN(new Date("technology 10").getTime()),x=["lat","latitude","latitude83","latdecdeg","lat_dd","y","ycenter","point-y"],y=["lon","lng","long","longitude","longitude83","longdecdeg","long_dd","x","xcenter","point-x"];export{u as inferDelimiterAndLocationInfo,m as inferFieldType,g as inferFields,p as isValidDate,b as parseNumber,c as parseRows,s as readRowParts,l as readRows,a as splitSingleRow};
